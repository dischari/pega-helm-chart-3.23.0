language: python
os: linux
dist: bionic
env:
  global:
    - HELM_URL=https://get.helm.sh
    - HELM_TGZ=helm-v3.2.4-linux-amd64.tar.gz
    - YAMLLINT_VERSION=1.15.0
    - TRAVIS_GO_VERSION=1.13.1
install:
  # Install Helm
  - wget -q ${HELM_URL}/${HELM_TGZ}
  - tar xzf ${HELM_TGZ}
  - PATH=`pwd`/linux-amd64/:$PATH
  # Install YamlLint
  - sudo pip install yamllint=="${YAMLLINT_VERSION}"
  - nvm install --lts
  - npm install -g --save remark-cli to-vfile remark-preset-lint-recommended remark-validate-links remark-lint-no-dead-urls remark-message-control remark-preset-lint-markdown-style-guide remark-lint
  # Install Go
  - eval "$(gimme 1.13.1)"
  - export  PATH=$PATH:/usr/local/go/bin
script:
  - yamllint -c .yamllint.yml -s $(find . -type f -name "Chart.yaml")
  - yamllint -c .yamllint.yml -s $(find . -type f -name "values*.yaml")
  - remark -i .remark_ignore -f -u validate-links .
  # Now load the helm dependencies
  - make dependencies
  # Run GO helm unit tests
  - mkdir $TRAVIS_BUILD_DIR/terratest/bin
  - export GOPATH=$TRAVIS_BUILD_DIR/terratest
  - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
  - export PATH=$PATH:$TRAVIS_BUILD_DIR/terratest/bin
  - cd terratest/src/test
  - dep ensure
  # grep -v command.go:158 - hack for filter unnecessary logs. 
  # It's needed because of lack ability to disable debug output in terratest for helm chart
  #  ; test ${PIPESTATUS[0]} -eq 0 - check if go test was finished success. Without it pipe return exit code from last command.
  - go test test/pega | grep -v command.go:158 ; test ${PIPESTATUS[0]} -eq 0
  - go test test/addons | grep -v command.go:158 ; test ${PIPESTATUS[0]} -eq 0
  - go test test/backingservices | grep -v command.go:158 ; test ${PIPESTATUS[0]} -eq 0
  - cd $TRAVIS_BUILD_DIR
  - chmod 777 before_deploy.sh
before_deploy:
  - ./before_deploy.sh  
  - make examples
deploy:
  - provider: releases
    api_key:
      secure: >
        RXH5TG6rk++JOOskmHSOMkU0q6UeDmKPHBrimryAINT+pfIlsVz
        zpT7hCB9DTmhv5HFTScamL3tAMm+/rYHTwv+Ags8UJpo9pSuxZ1
        2QeuepRuivEJCP4O095vk/mphOmrK7XXYndTaNn79kBL+w2WENI
        4MgxVwki1jK1J1pEwzk8r521E7efx3KXCUdoqQxTO2NpbVEnYvT
        7Ah3WgfKpZCsqSfnjUV8nSJb4Fkn/tG9/otRfhD7WeiNrrh9W/t
        vVcjNzJXXoCdgoK0bTFRiwm+PSFmRVEfmXgI0W7FZjXTv6u6Y33
        VhYQ/sDDo3TtDqb6NztFpXulNGilFeYvimF2LSydur6t/Lvj0Qd
        cUyvpyIGyU/kZhcug8GDg9OxG8n0rpvbTiRP+dqYMNdo9CmBV4L
        7wtsSYwOmjXSHgraSf+9xLHJBKmwIKJy1RH/H8SCDaDtlQiPWzb
        d2k6UcOBOJIWsHkPNQcsClwdZo6In+UbAtmoeFivLf1sWfpQQq5
        Qo405P31k3d8uiMtKpAmQ+KqWZ/Ju5HQocjRN7pNxERpGosKXcu
        ZKiYUiJJJwwteFhwORrZKNQiQTmLeDz6Ho6J7u1PUw50JlRH0ZQ
        q82JuinvnCKZ48mtVFKqZMx6/TE9JJ9u+DcCjJG5KO4dHcRyDYy
        2xx9s1mUQFlgOf+Qxlak=
    file:
      - pega-kubernetes-example.tar.gz
      - pega-openshift-example.tar.gz
      - pega-azure-aks-example.tar.gz
      - pega-aws-eks-example.tar.gz
      - pega-google-gke-example.tar.gz
      - pega-pivotal-pks-example.tar.gz
    skip_cleanup: true
    on:
      repo: $TRAVIS_REPO_SLUG
      tags: true
  - provider: pages
    github-token: $GITHUB_TOKEN
    api_key:
      secure: >
        RXH5TG6rk++JOOskmHSOMkU0q6UeDmKPHBrimryAINT+pfIlsVz
        zpT7hCB9DTmhv5HFTScamL3tAMm+/rYHTwv+Ags8UJpo9pSuxZ1
        2QeuepRuivEJCP4O095vk/mphOmrK7XXYndTaNn79kBL+w2WENI
        4MgxVwki1jK1J1pEwzk8r521E7efx3KXCUdoqQxTO2NpbVEnYvT
        7Ah3WgfKpZCsqSfnjUV8nSJb4Fkn/tG9/otRfhD7WeiNrrh9W/t
        vVcjNzJXXoCdgoK0bTFRiwm+PSFmRVEfmXgI0W7FZjXTv6u6Y33
        VhYQ/sDDo3TtDqb6NztFpXulNGilFeYvimF2LSydur6t/Lvj0Qd
        cUyvpyIGyU/kZhcug8GDg9OxG8n0rpvbTiRP+dqYMNdo9CmBV4L
        7wtsSYwOmjXSHgraSf+9xLHJBKmwIKJy1RH/H8SCDaDtlQiPWzb
        d2k6UcOBOJIWsHkPNQcsClwdZo6In+UbAtmoeFivLf1sWfpQQq5
        Qo405P31k3d8uiMtKpAmQ+KqWZ/Ju5HQocjRN7pNxERpGosKXcu
        ZKiYUiJJJwwteFhwORrZKNQiQTmLeDz6Ho6J7u1PUw50JlRH0ZQ
        q82JuinvnCKZ48mtVFKqZMx6/TE9JJ9u+DcCjJG5KO4dHcRyDYy
        2xx9s1mUQFlgOf+Qxlak=
    file:
        - index.yaml
    skip_cleanup: true
    target_branch: gh-pages
    keep_history: true
    verbose: true
    on:
      all_branches: true
      repo: $TRAVIS_REPO_SLUG
      draft: true
