<?xml version='1.0' encoding='utf-8'?>
<Context>

  <WatchedResource>WEB-INF/web.xml</WatchedResource>

  <Manager pathname="" />
    <Resource name="jdbc/PegaRULES"
    auth="Container"
    type="javax.sql.DataSource"
    driverClassName="{{ .Env.JDBC_CLASS }}"
    url="{{ .Env.JDBC_URL }}"
    username="{{ .Env.SECRET_DB_USERNAME }}"
    password="{{ .Env.SECRET_DB_PASSWORD }}"
    maxTotal="{{ .Env.JDBC_MAX_ACTIVE }}"
    minIdle="{{ .Env.JDBC_MIN_IDLE }}"
    maxIdle="{{ .Env.JDBC_MAX_IDLE }}"
    maxWaitMillis="{{ .Env.JDBC_MAX_WAIT }}"
    initialSize="{{ .Env.JDBC_INITIAL_SIZE }}"
    connectionProperties="{{ .Env.JDBC_CONNECTION_PROPERTIES }}"
    timeBetweenEvictionRunsMillis="30000"
    minEvictableIdleTimeMillis="60000"
    />

  {{ if or .Env.SET_RW .Env.JDBC_RW_URL }}
    <Resource name="jdbc/PegaRULESLongRW"
    auth="Container"
    type="javax.sql.DataSource"
    driverClassName="{{ .Env.JDBC_CLASS }}"
    url="{{- if .Env.JDBC_RW_URL -}}{{ .Env.JDBC_RW_URL }}{{- else -}}{{ .Env.JDBC_URL }}{{- end -}}"
    username="{{ .Env.SECRET_DB_USERNAME }}"
    password="{{ .Env.SECRET_DB_PASSWORD }}"
    maxTotal="{{ .Env.JDBC_MAX_ACTIVE }}"
    minIdle="{{ .Env.JDBC_MIN_IDLE }}"
    maxIdle="{{ .Env.JDBC_MAX_IDLE }}"
    maxWaitMillis="{{ .Env.JDBC_MAX_WAIT }}"
    initialSize="{{ .Env.JDBC_INITIAL_SIZE }}"
    connectionProperties="{{ .Env.JDBC_CONNECTION_PROPERTIES }};socketTimeout=1200;statement_timeout=1200500;idle_in_transaction_session_timeout=1200500;"
    timeBetweenEvictionRunsMillis="30000"
    minEvictableIdleTimeMillis="60000"
    />
  {{ end }}

  {{ if and .Env.JDBC_RO_URL .Env.DB_RO_USERNAME .Env.DB_RO_PASSWORD }}
    <Resource name="jdbc/PegaRULESReadOnly"
    auth="Container"
    type="javax.sql.DataSource"
    driverClassName="{{ .Env.JDBC_CLASS }}"
    url="{{ .Env.JDBC_RO_URL }}"
    username="{{ .Env.DB_RO_USERNAME }}"
    password="{{ .Env.DB_RO_PASSWORD }}"
    maxTotal="{{ .Env.JDBC_MAX_ACTIVE }}"
    minIdle="{{ default .Env.JDBC_RO_MIN_IDLE .Env.JDBC_MIN_IDLE }}"
    maxIdle="{{ .Env.JDBC_MAX_IDLE }}"
    maxWaitMillis="{{ .Env.JDBC_MAX_WAIT }}"
    initialSize="{{ default .Env.JDBC_RO_INITIAL_SIZE .Env.JDBC_INITIAL_SIZE }}"
    connectionProperties="{{ .Env.JDBC_CONNECTION_PROPERTIES }}"
    timeBetweenEvictionRunsMillis="30000"
    minEvictableIdleTimeMillis="60000"
    />


  <Environment name="prconfig/database/databases/PegaRULES/dataSourceReadOnly" value="java:comp/env/jdbc/PegaRULESReadOnly" type="java.lang.String" />
  <Environment name="prconfig/database/databases/PegaDATA/dataSourceReadOnly" value="java:comp/env/jdbc/PegaRULESReadOnly" type="java.lang.String" />
  {{ if .Env.CUSTOMERDATA_SCHEMA }}
  <Environment name="prconfig/database/databases/CustomerData/dataSourceReadOnly" value="java:comp/env/jdbc/PegaRULESReadOnly" type="java.lang.String" />
  {{ end }}
  {{ end }}

  <Environment name="url/initialization/explicittempdir" value="path" type="java.lang.String"/>
  <Environment name="prconfig/database/databases/PegaRULES/defaultSchema" value="{{ .Env.RULES_SCHEMA }}" type="java.lang.String" />
  <Environment name="prconfig/database/databases/PegaDATA/defaultSchema"  value="{{ .Env.DATA_SCHEMA }}"  type="java.lang.String" />
  {{ if .Env.CUSTOMERDATA_SCHEMA }}
  <Environment name="prconfig/database/databases/CustomerData/defaultSchema" value="{{ .Env.CUSTOMERDATA_SCHEMA }}" type="java.lang.String" />
  {{ else }}
  <Environment name="prconfig/database/databases/CustomerData/defaultSchema" value="{{ .Env.DATA_SCHEMA }}" type="java.lang.String" />
  {{ end }}
  {{ if .Env.REQUESTOR_PASSIVATION_TIMEOUT }}
  <Environment name="prconfig/timeout/browser" value="{{ .Env.REQUESTOR_PASSIVATION_TIMEOUT }}" type="java.lang.String" />
  {{ end }}

  {{ if .Env.EXTERNAL_STREAM }}
  <Environment name="prconfig/services/stream/validate" value="true" type="java.lang.String"/>
  <Environment name="prconfig/services/stream/provider" value="ExternalKafka" type="java.lang.String" />
  <Environment name="prconfig/services/stream/broker/url" value="{{ .Env.STREAM_BOOTSTRAP_SERVERS }}" type="java.lang.String" />
  <Environment name="prconfig/services/stream/encryption/security/protocol" value="{{ .Env.STREAM_SECURITY_PROTOCOL }}" type="java.lang.String" />
  <Environment name="prconfig/services/stream/encryption/sasl/mechanism" value="{{ .Env.STREAM_SASL_MECHANISM }}" type="java.lang.String" />
  {{ if .Env.STREAM_TRUSTSTORE }}
  <Environment name="prconfig/services/stream/encryption/truststore/path" value="{{ .Env.STREAM_TRUSTSTORE }}" type="java.lang.String"/>
  {{ end }}
  {{ if .Env.STREAM_TRUSTSTORE_TYPE }}
  <Environment name="prconfig/services/stream/encryption/truststore/type" value="{{ .Env.STREAM_TRUSTSTORE_TYPE }}" type="java.lang.String" />
  {{ end }}
  {{ if .Env.STREAM_KEYSTORE }}
  <Environment name="prconfig/services/stream/encryption/keystore/path" value="{{ .Env.STREAM_KEYSTORE }}" type="java.lang.String"/>
  {{ end }}
  {{ if .Env.STREAM_KEYSTORE_TYPE }}
  <Environment name="prconfig/services/stream/encryption/keystore/type" value="{{ .Env.STREAM_KEYSTORE_TYPE }}" type="java.lang.String" />
  {{ end }}
  {{ if .Env.STREAM_NAME_PATTERN }}
  <Environment name="prconfig/services/stream/name/pattern" value="{{ .Env.STREAM_NAME_PATTERN }}" type="java.lang.String" />
  {{ end }}
  {{ if .Env.STREAM_REPLICATION_FACTOR }}
  <Environment name="prconfig/services/stream/external/replication/factor" value="{{ .Env.STREAM_REPLICATION_FACTOR }}" type="java.lang.String" />
  {{ end }}
  {{ end }}

  {{ if .Env.CONTEXT_XML_SNIPPET }}
  {{ .Env.CONTEXT_XML_SNIPPET }}
  {{ end }}

</Context>